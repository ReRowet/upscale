name: Real-ESRGAN Image Upscale

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]
  
  workflow_dispatch:  # Manual trigger

jobs:
  upscale:
    runs-on: ubuntu-20.04  # Ubuntu 20.04 lebih stabil
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Python 3.8
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        
    - name: Install Python packages
      run: |
        # HAPUS numpy jika ada
        pip uninstall -y numpy || true
        
        # INSTALL numpy 1.x DULU
        pip install "numpy==1.24.3"
        
        # Install PyTorch
        pip install torch==1.13.1 torchvision==0.14.1 --index-url https://download.pytorch.org/whl/cpu
        
        # Install package lain
        pip install Pillow==9.5.0
        pip install opencv-python-headless==4.6.0.66
        pip install basicsr==1.4.2
        pip install facexlib==0.3.0
        pip install gfpgan==1.3.8
        pip install realesrgan==0.3.0
        
    - name: Download Real-ESRGAN model
      run: |
        mkdir -p weights
        wget -O weights/realesr-general-x4v3.pth \
          https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
          
    - name: Create simple upscale script
      run: |
        cat > upscale.py << 'EOF'
        import os
        import sys
        import glob
        from PIL import Image
        
        # Import Real-ESRGAN
        sys.path.insert(0, '/opt/hostedtoolcache/Python/3.8.18/x64/lib/python3.8/site-packages')
        
        try:
            from realesrgan import RealESRGAN
            print("âœ“ Real-ESRGAN imported successfully")
        except ImportError as e:
            print(f"âœ— Error importing Real-ESRGAN: {e}")
            sys.exit(1)
        
        def main():
            # Setup
            input_dir = "images"
            output_dir = "upscaled"
            
            if not os.path.exists(input_dir):
                print(f"âœ— Error: {input_dir} directory not found!")
                print("  Please add images to the 'images' folder")
                return
            
            os.makedirs(output_dir, exist_ok=True)
            
            print(f"Input: {input_dir}")
            print(f"Output: {output_dir}")
            
            # Initialize model
            print("\nLoading Real-ESRGAN model...")
            try:
                import torch
                device = torch.device('cpu')
                model = RealESRGAN(device, scale=4)
                model.load_weights('weights/realesr-general-x4v3.pth')
                print("âœ“ Model loaded successfully")
            except Exception as e:
                print(f"âœ— Error loading model: {e}")
                return
            
            # Find images
            images = []
            for ext in ['.jpg', '.jpeg', '.png', '.bmp', '.webp']:
                pattern = os.path.join(input_dir, '**', f'*{ext}')
                images.extend(glob.glob(pattern, recursive=True))
                images.extend(glob.glob(pattern.upper(), recursive=True))
            
            print(f"\nFound {len(images)} images")
            
            if len(images) == 0:
                print("âœ— No images found!")
                return
            
            # Process images
            success = 0
            for i, img_path in enumerate(images, 1):
                try:
                    filename = os.path.basename(img_path)
                    output_path = os.path.join(output_dir, filename)
                    
                    print(f"[{i}/{len(images)}] Processing: {filename}")
                    
                    # Open and upscale
                    img = Image.open(img_path).convert('RGB')
                    sr_img = model.predict(img)
                    
                    # Save
                    sr_img.save(output_path)
                    success += 1
                    print(f"  âœ“ Saved as {filename}")
                    
                except Exception as e:
                    print(f"  âœ— Error: {str(e)[:100]}")
            
            # Summary
            print(f"\n{'='*50}")
            print(f"RESULT: {success}/{len(images)} images upscaled")
            print(f"{'='*50}")
            
            if success == 0:
                print("\nâœ— No images were processed successfully!")
                sys.exit(1)
            else:
                print("\nâœ… Upscaling completed successfully!")
        
        if __name__ == "__main__":
            main()
        EOF
        
    - name: Run upscaling
      run: python upscale.py
      
    - name: Upload upscaled images
      uses: actions/upload-artifact@v3
      with:
        name: upscaled-images
        path: upscaled/
        
    - name: Create summary
      run: |
        echo "## ðŸ–¼ï¸ Image Upscaling Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "upscaled" ]; then
          count=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
          echo "âœ… **Successfully upscaled $count images!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Files generated:" >> $GITHUB_STEP_SUMMARY
          ls -la upscaled/*.{jpg,jpeg,png} 2>/dev/null | head -10 | while read line; do
            echo "- $line" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the images from the Artifacts section." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Upscaling failed**" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for errors." >> $GITHUB_STEP_SUMMARY
        fi