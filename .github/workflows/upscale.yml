name: Real-ESRGAN Upscale (Correct Architecture)

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]

jobs:
  upscale:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with: 
          python-version: "3.10"
          
      - name: Install dependencies (CLEAN INSTALL)
        run: |
          # Clean installation
          pip install --upgrade pip
          
          # Install numpy 1.x FIRST
          pip install "numpy==1.24.3"
          
          # Install PyTorch
          pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
          
          # Install Real-ESRGAN dan dependencies
          pip install basicsr==1.4.2
          pip install facexlib==0.3.0
          pip install gfpgan==1.3.8
          pip install Pillow==9.5.0
          pip install opencv-python-headless==4.8.1.78
          pip install realesrgan==0.3.0
          
      - name: Download model
        run: |
          mkdir -p weights
          wget -q -O weights/realesr-general-x4v3.pth \
            https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
          
      - name: Create correct upscale script
        run: |
          cat > upscale_correct.py << 'EOF'
          """
          Real-ESRGAN Upscaler with correct architecture
          """
          import os
          import sys
          import glob
          import cv2
          import numpy as np
          from pathlib import Path
          from PIL import Image
          import torch
          
          # Import Real-ESRGAN components
          try:
              from basicsr.archs.rrdbnet_arch import RRDBNet
              from realesrgan.archs.srvgg_arch import SRVGGNetCompact
              from realesrgan import RealESRGANer
          except ImportError:
              print("Error importing Real-ESRGAN. Make sure it's installed.")
              sys.exit(1)
          
          def determine_model_type(model_path):
              """Determine model type from filename"""
              model_name = os.path.basename(model_path).lower()
              
              if 'realesr-general-x4v3' in model_name:
                  return 'SRVGGNetCompact', 4
              elif 'realesr-general-wdn-x4v3' in model_name:
                  return 'SRVGGNetCompact', 4
              elif 'realesr-animevideov3' in model_name:
                  return 'SRVGGNetCompact', 4
              elif 'realesrgan-x4plus' in model_name:
                  return 'RRDBNet', 4
              elif 'realesrnet-x4plus' in model_name:
                  return 'RRDBNet', 4
              else:
                  # Default to SRVGGNetCompact for general-x4v3
                  return 'SRVGGNetCompact', 4
          
          def main():
              # Configuration
              input_dir = "images"
              output_dir = "upscaled"
              model_path = "weights/realesr-general-x4v3.pth"
              
              # Determine model type
              model_type, scale = determine_model_type(model_path)
              print(f"Model type: {model_type}, Scale: {scale}x")
              
              # Create output directory
              os.makedirs(output_dir, exist_ok=True)
              
              # Initialize model based on type
              if model_type == 'SRVGGNetCompact':
                  print("Initializing SRVGGNetCompact model...")
                  model = SRVGGNetCompact(
                      num_in_ch=3,
                      num_out_ch=3,
                      num_feat=64,
                      num_conv=32,
                      upscale=scale,
                      act_type='prelu'
                  )
              else:  # RRDBNet
                  print("Initializing RRDBNet model...")
                  model = RRDBNet(
                      num_in_ch=3,
                      num_out_ch=3,
                      num_feat=64,
                      num_block=23,
                      num_grow_ch=32,
                      scale=scale
                  )
              
              # Initialize upsampler
              upsampler = RealESRGANer(
                  scale=scale,
                  model_path=model_path,
                  model=model,
                  tile=0,  # No tiling for simplicity
                  tile_pad=10,
                  pre_pad=0,
                  half=False,  # CPU doesn't support half precision
                  device=torch.device('cpu')
              )
              
              print("Model loaded successfully!")
              
              # Find all images
              image_extensions = ['.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.webp']
              image_files = []
              
              for ext in image_extensions:
                  image_files.extend(glob.glob(os.path.join(input_dir, '**', f'*{ext}'), recursive=True))
                  image_files.extend(glob.glob(os.path.join(input_dir, '**', f'*{ext.upper()}'), recursive=True))
              
              print(f"Found {len(image_files)} images to process")
              
              # Process images
              success_count = 0
              
              for i, img_path in enumerate(image_files):
                  try:
                      # Create output path preserving directory structure
                      rel_path = os.path.relpath(img_path, input_dir)
                      output_path = os.path.join(output_dir, rel_path)
                      os.makedirs(os.path.dirname(output_path), exist_ok=True)
                      
                      print(f"[{i+1}/{len(image_files)}] Processing: {rel_path}")
                      
                      # Read image
                      img = cv2.imread(img_path, cv2.IMREAD_UNCHANGED)
                      if img is None:
                          print(f"  Warning: Could not read image, skipping...")
                          continue
                      
                      # Upscale
                      output, _ = upsampler.enhance(img, outscale=scale)
                      
                      # Save image
                      cv2.imwrite(output_path, output)
                      success_count += 1
                      
                      print(f"  âœ“ Saved to: {rel_path}")
                      
                  except Exception as e:
                      print(f"  âœ— Error: {str(e)}")
              
              # Summary
              print("\n" + "="*50)
              print("PROCESSING SUMMARY")
              print("="*50)
              print(f"Total images found: {len(image_files)}")
              print(f"Successfully upscaled: {success_count}")
              print(f"Failed: {len(image_files) - success_count}")
              print("="*50)
              
              if success_count == 0:
                  print("No images were processed successfully!")
                  sys.exit(1)
              
              # Create a simple HTML preview
              if success_count > 0:
                  create_html_preview(output_dir)
          
          def create_html_preview(output_dir):
              """Create a simple HTML preview of results"""
              html_path = os.path.join(output_dir, "preview.html")
              
              # Find first few images
              preview_images = []
              for ext in ['.jpg', '.jpeg', '.png']:
                  preview_images.extend(glob.glob(os.path.join(output_dir, '**', f'*{ext}'), recursive=True)[:5])
              
              with open(html_path, 'w') as f:
                  f.write("""
                  <!DOCTYPE html>
                  <html>
                  <head>
                      <title>Upscaled Images Preview</title>
                      <style>
                          body { font-family: Arial, sans-serif; margin: 20px; }
                          .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
                          .image-container { border: 1px solid #ddd; padding: 10px; border-radius: 5px; }
                          img { max-width: 100%; height: auto; }
                          .filename { font-size: 12px; color: #666; margin-top: 5px; }
                      </style>
                  </head>
                  <body>
                      <h1>Upscaled Images Preview</h1>
                      <div class="image-grid">
                  """)
                  
                  for img_path in preview_images:
                      rel_path = os.path.relpath(img_path, output_dir)
                      f.write(f"""
                          <div class="image-container">
                              <img src="{rel_path}" alt="{rel_path}">
                              <div class="filename">{rel_path}</div>
                          </div>
                      """)
                  
                  f.write("""
                      </div>
                      <p>Total images upscaled: """ + str(len(glob.glob(os.path.join(output_dir, '**', '*.*'), recursive=True))) + """</p>
                  </body>
                  </html>
                  """)
              
              print(f"Preview created: {html_path}")
          
          if __name__ == "__main__":
              main()
          EOF
          
      - name: Run upscaling
        run: |
          echo "Starting upscaling with correct architecture..."
          python upscale_correct.py
          
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: upscaled-images
          path: |
            upscaled/**
            !upscaled/.gitkeep
          retention-days: 90
          
      - name: Create summary
        run: |
          echo "## âœ… Real-ESRGAN Upscaling Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "upscaled" ]; then
            total_files=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" -o -name "*.webp" -o -name "*.bmp" \) | wc -l)
            
            echo "### ðŸ“Š Processing Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Images Processed**: $total_files" >> $GITHUB_STEP_SUMMARY
            echo "- **Model Used**: RealESRGAN general-x4v3 (SRVGGNetCompact)" >> $GITHUB_STEP_SUMMARY
            echo "- **Scale Factor**: 4x" >> $GITHUB_STEP_SUMMARY
            echo "- **Preview**: [preview.html](upscaled/preview.html)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show folder structure
            echo "### ðŸ“ Output Structure" >> $GITHUB_STEP_SUMMARY
            find upscaled -type d | sort | head -10 | while read dir; do
              count=$(find "$dir" -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
              if [ $count -gt 0 ]; then
                dir_name=${dir#upscaled/}
                [ -z "$dir_name" ] && dir_name="root"
                echo "- **$dir_name**: $count images" >> $GITHUB_STEP_SUMMARY
              fi
            done
            
          else
            echo "### âŒ No Output Generated" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs for errors." >> $GITHUB_STEP_SUMMARY
          fi