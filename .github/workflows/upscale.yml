name: Real-ESRGAN Upscale (Clean Install)

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]

jobs:
  upscale:
    runs-on: ubuntu-22.04  # Ubuntu 22.04 lebih stabil
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python 3.9 (lebih compatible)
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Create clean virtual environment
      run: |
        python -m venv venv
        source venv/bin/activate
        
        # HAPUS SEMUA package system
        pip uninstall -y numpy opencv-python opencv-python-headless torch torchvision || true
        
        # INSTALL numpy 1.x DENGAN FORCE
        pip install --no-deps "numpy==1.24.3"
        pip install "numpy==1.24.3" --force-reinstall
        
        # Verifikasi
        python -c "import numpy; print(f'NumPy: {numpy.__version__}'); assert numpy.__version__ == '1.24.3'"
        
        # Install PyTorch
        pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
        
        # Install basicsr dan realesrgan DARI SOURCE
        pip install opencv-python-headless==4.8.1.78
        pip install Pillow==9.5.0
        
        # Clone basicsr dan install
        git clone https://github.com/xinntao/BasicSR.git
        cd BasicSR
        pip install -e .
        cd ..
        
        # Install realesrgan
        pip install realesrgan==0.3.0
        
        echo "VIRTUAL_ENV=$(pwd)/venv" >> $GITHUB_ENV
        echo "$(pwd)/venv/bin" >> $GITHUB_PATH
        
    - name: Create simplified upscale script (NO basicsr import)
      run: |
        cat > upscale_simple.py << 'EOF'
        """
        Simplified Real-ESRGAN upscaler
        Avoids problematic imports
        """
        import os
        import sys
        import glob
        import traceback
        from pathlib import Path
        
        # Add venv to path
        venv_path = os.path.join(os.path.dirname(__file__), 'venv', 'lib', 'python3.9', 'site-packages')
        sys.path.insert(0, venv_path)
        
        print("=" * 60)
        print("Real-ESRGAN Simplified Upscaler")
        print("=" * 60)
        
        # Try basic imports
        try:
            import numpy as np
            import torch
            from PIL import Image
            import cv2
            print(f"âœ“ Basic imports: NumPy {np.__version__}, PyTorch {torch.__version__}")
        except ImportError as e:
            print(f"âœ— Basic import error: {e}")
            sys.exit(1)
        
        # Try to import Real-ESRGAN directly
        try:
            # Try different import methods
            try:
                from realesrgan import RealESRGAN
                print("âœ“ Imported RealESRGAN class")
                USE_CLASS = True
            except:
                # Alternative import
                from basicsr.archs.srvgg_arch import SRVGGNetCompact
                from realesrgan import RealESRGANer
                print("âœ“ Imported RealESRGANer")
                USE_CLASS = False
        except Exception as e:
            print(f"âœ— Real-ESRGAN import error: {e}")
            print("Trying manual approach...")
            traceback.print_exc()
            sys.exit(1)
        
        def upscale_with_class(img_path, output_path, model_path, device='cpu', scale=4):
            """Upscale using RealESRGAN class"""
            try:
                device = torch.device(device)
                model = RealESRGAN(device, scale=scale)
                model.load_weights(model_path)
                
                img = Image.open(img_path).convert('RGB')
                sr_img = model.predict(img)
                sr_img.save(output_path)
                return True
            except Exception as e:
                print(f"  Class method error: {e}")
                return False
        
        def upscale_with_upsampler(img_path, output_path, model_path, scale=4):
            """Upscale using RealESRGANer"""
            try:
                model = SRVGGNetCompact(
                    num_in_ch=3, num_out_ch=3, num_feat=64,
                    num_conv=32, upscale=scale, act_type='prelu'
                )
                
                upsampler = RealESRGANer(
                    scale=scale,
                    model_path=model_path,
                    model=model,
                    tile=0,
                    tile_pad=10,
                    pre_pad=0,
                    half=False,
                    device='cpu'
                )
                
                img = cv2.imread(str(img_path), cv2.IMREAD_UNCHANGED)
                if img is None:
                    return False
                
                output, _ = upsampler.enhance(img, outscale=scale)
                cv2.imwrite(str(output_path), output)
                return True
            except Exception as e:
                print(f"  Upsampler error: {e}")
                return False
        
        def main():
            import argparse
            
            parser = argparse.ArgumentParser()
            parser.add_argument('--input', default='images', help='Input directory')
            parser.add_argument('--output', default='upscaled', help='Output directory')
            parser.add_argument('--model', default='models/realesr-general-wdn-x4v3.pth', help='Model path')
            parser.add_argument('--scale', type=int, default=4, help='Upscale factor')
            
            args = parser.parse_args()
            
            # Setup paths
            input_dir = Path(args.input)
            output_dir = Path(args.output)
            model_path = Path(args.model)
            
            if not input_dir.exists():
                print(f"âœ— Input directory not found: {input_dir}")
                return
            
            if not model_path.exists():
                print(f"âœ— Model not found: {model_path}")
                print("  Make sure model is in models/ folder")
                return
            
            output_dir.mkdir(parents=True, exist_ok=True)
            
            print(f"\nInput: {input_dir}")
            print(f"Output: {output_dir}")
            print(f"Model: {model_path.name}")
            print(f"Scale: {args.scale}x")
            
            # Find images
            images = []
            for ext in ['.jpg', '.jpeg', '.png', '.bmp', '.webp']:
                pattern = str(input_dir / '**' / f'*{ext}')
                images.extend(glob.glob(pattern, recursive=True))
            
            print(f"\nFound {len(images)} images")
            
            if not images:
                print("âœ— No images found!")
                return
            
            # Process images
            success = 0
            
            for i, img_file in enumerate(images, 1):
                img_path = Path(img_file)
                rel_path = img_path.relative_to(input_dir) if input_dir in img_path.parents else img_path.name
                output_path = output_dir / rel_path
                output_path.parent.mkdir(parents=True, exist_ok=True)
                
                print(f"[{i}/{len(images)}] {rel_path}")
                
                # Try method 1 (RealESRGAN class)
                if USE_CLASS:
                    if upscale_with_class(img_path, output_path, str(model_path), scale=args.scale):
                        success += 1
                        print(f"  âœ“ Saved")
                        continue
                
                # Try method 2 (RealESRGANer)
                if not USE_CLASS or success == 0:
                    if upscale_with_upsampler(img_path, output_path, str(model_path), scale=args.scale):
                        success += 1
                        print(f"  âœ“ Saved")
                    else:
                        print(f"  âœ— Failed")
            
            # Summary
            print(f"\n{'='*60}")
            print(f"RESULT: {success}/{len(images)} images upscaled")
            print(f"{'='*60}")
            
            if success == 0:
                print("\nâœ— No images processed successfully!")
                sys.exit(1)
            
            print("\nâœ… Done!")
            
            # Create info file
            info_file = output_dir / "info.txt"
            with open(info_file, 'w') as f:
                f.write(f"Model: {model_path.name}\n")
                f.write(f"Scale: {args.scale}x\n")
                f.write(f"Images: {success}/{len(images)}\n")
        
        if __name__ == "__main__":
            main()
        EOF
        
    - name: Run upscaling
      run: |
        source venv/bin/activate
        python upscale_simple.py
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: upscaled-images
        path: upscaled/
        
    - name: Create summary
      run: |
        echo "## ðŸ“Š Upscaling Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "upscaled" ]; then
          count=$(ls -1 upscaled/*.{jpg,jpeg,png} 2>/dev/null | wc -l)
          echo "âœ… **Successfully upscaled $count images**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download from Artifacts section." >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Processing failed**" >> $GITHUB_STEP_SUMMARY
          echo "Check workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi