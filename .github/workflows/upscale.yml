name: Real-ESRGAN CPU Upscale (Stable)

on:
  workflow_dispatch:
  push:
    paths:
      - "images/**"

jobs:
  upscale:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies (LOCKED VERSIONS)
        run: |
          python -m pip install --upgrade pip
          pip install \
            numpy==1.26.4 \
            torch==2.0.1+cpu \
            torchvision==0.15.2+cpu \
            -f https://download.pytorch.org/whl/cpu/torch_stable.html
          pip install realesrgan==0.3.0 basicsr==1.4.2 pillow

      - name: Download Real-ESRGAN model (v0.2.5.0)
        run: |
          mkdir -p weights
          wget -O weights/realesr-general-x4v3.pth \
            https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth

      - name: Run upscale (CPU only)
        run: |
          mkdir -p upscaled
          python << 'EOF'
          import os
          import torch
          from PIL import Image
          from realesrgan import RealESRGAN

          device = torch.device("cpu")
          model = RealESRGAN(device, scale=4)
          model.load_weights("weights/realesr-general-x4v3.pth")

          for file in os.listdir("images"):
              if file.lower().endswith((".png", ".jpg", ".jpeg")):
                  img = Image.open(os.path.join("images", file)).convert("RGB")
                  sr = model.predict(img)
                  sr.save(os.path.join("upscaled", file))
          EOF

      - name: Upload upscaled images
        uses: actions/upload-artifact@v4
        with:
          name: upscaled-images
          path: upscaled
