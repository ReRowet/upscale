name: Real-ESRGAN CPU (Python Stable)

on:
  workflow_dispatch:
  push:
    paths:
      - "images/**"

jobs:
  upscale:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies (LOCKED)
        run: |
          python -m pip install --upgrade pip
          pip install \
            numpy==1.26.4 \
            torch==2.0.1+cpu \
            torchvision==0.15.2+cpu \
            -f https://download.pytorch.org/whl/cpu/torch_stable.html
          pip install realesrgan==0.3.0 basicsr==1.4.2

      - name: Download model
        run: |
          mkdir -p weights
          wget -O weights/RealESRGAN_x4plus.pth \
            https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/RealESRGAN_x4plus.pth

      - name: Run upscale (CPU)
        run: |
          mkdir -p upscaled
          python - << 'EOF'
          from realesrgan import RealESRGAN
          from PIL import Image
          import torch, os

          device = torch.device("cpu")
          model = RealESRGAN(device, scale=4)
          model.load_weights("weights/RealESRGAN_x4plus.pth")

          os.makedirs("upscaled", exist_ok=True)

          for f in os.listdir("images"):
              if f.lower().endswith((".png",".jpg",".jpeg")):
                  img = Image.open(f"images/{f}").convert("RGB")
                  sr = model.predict(img)
                  sr.save(f"upscaled/{f}")
          EOF

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: upscaled-images
          path: upscaled
