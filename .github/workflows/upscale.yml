name: Real-ESRGAN Direct Upscale

on:
  push:
    paths:
      - 'images/**'
    branches: [ main ]

jobs:
  upscale:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Clone Real-ESRGAN repo
      run: |
        git clone https://github.com/xinntao/Real-ESRGAN.git
        cd Real-ESRGAN
        
    - name: Install dependencies
      run: |
        cd Real-ESRGAN
        pip install --upgrade pip
        pip install numpy==1.24.3
        pip install -r requirements.txt
        pip install basicsr==1.4.2
        pip install facexlib==0.3.0
        pip install gfpgan==1.3.8
        pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
        
    - name: Download model
      run: |
        cd Real-ESRGAN
        wget -q -O weights/realesr-general-x4v3.pth \
          https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
        
    - name: Create inference script
      run: |
        cd Real-ESRGAN
        cat > inference.py << 'EOF'
        import os
        import sys
        import cv2
        import glob
        import argparse
        
        # Add current directory to path
        sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
        
        from basicsr.archs.srvgg_arch import SRVGGNetCompact
        from realesrgan import RealESRGANer
        
        def main():
            parser = argparse.ArgumentParser()
            parser.add_argument('--input', type=str, default='../images', help='Input folder')
            parser.add_argument('--output', type=str, default='../upscaled', help='Output folder')
            parser.add_argument('--model', type=str, default='weights/realesr-general-x4v3.pth', help='Model path')
            args = parser.parse_args()
            
            # Create output directory
            os.makedirs(args.output, exist_ok=True)
            
            # Initialize model
            print("Loading Real-ESRGAN model...")
            model = SRVGGNetCompact(
                num_in_ch=3, num_out_ch=3, num_feat=64,
                num_conv=32, upscale=4, act_type='prelu'
            )
            
            # Initialize upsampler
            upsampler = RealESRGANer(
                scale=4,
                model_path=args.model,
                model=model,
                tile=0,
                tile_pad=10,
                pre_pad=0,
                half=False,
                device='cpu'
            )
            
            print("Model loaded successfully!")
            
            # Find images
            images = []
            for ext in ['*.jpg', '*.jpeg', '*.png', '*.bmp', '*.webp']:
                images.extend(glob.glob(os.path.join(args.input, '**', ext), recursive=True))
            
            print(f"Found {len(images)} images")
            
            # Process images
            for i, img_path in enumerate(images):
                try:
                    filename = os.path.basename(img_path)
                    output_path = os.path.join(args.output, filename)
                    
                    print(f"[{i+1}/{len(images)}] Processing {filename}")
                    
                    # Read and upscale
                    img = cv2.imread(img_path, cv2.IMREAD_UNCHANGED)
                    if img is None:
                        print(f"  Failed to read image")
                        continue
                    
                    output, _ = upsampler.enhance(img, outscale=4)
                    cv2.imwrite(output_path, output)
                    
                    print(f"  Saved as {filename}")
                    
                except Exception as e:
                    print(f"  Error: {e}")
            
            print(f"\nDone! Processed {len(images)} images")
            
        if __name__ == "__main__":
            main()
        EOF
        
    - name: Run inference
      run: |
        cd Real-ESRGAN
        python inference.py
        
    - name: Copy results
      run: |
        mkdir -p upscaled
        cp -r Real-ESRGAN/../upscaled/* upscaled/ 2>/dev/null || true
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: upscaled-images
        path: upscaled/