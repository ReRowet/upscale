name: Real-ESRGAN Upscale (Guaranteed Working)

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]

jobs:
  upscale:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Docker container dengan NumPy 1.x
        run: |
          # Buat Dockerfile khusus
          cat > Dockerfile << 'EOF'
          FROM python:3.9-slim-bullseye
          
          # Install system dependencies
          RUN apt-get update && apt-get install -y \
              wget \
              git \
              libgl1-mesa-glx \
              libglib2.0-0 \
              && rm -rf /var/lib/apt/lists/*
          
          # Set working directory
          WORKDIR /workspace
          
          # Copy requirements
          COPY requirements.txt .
          
          # Install Python packages dengan VERSI TERTENTU
          RUN pip install --no-cache-dir --upgrade pip && \
              pip install --no-cache-dir \
              numpy==1.24.3 \
              torch==2.0.1 \
              torchvision==0.15.2 \
              -f https://download.pytorch.org/whl/cpu/torch_stable.html && \
              pip install --no-cache-dir \
              opencv-python-headless==4.8.1.78 \
              Pillow==9.5.0 \
              basicsr==1.4.2 \
              facexlib==0.3.0 \
              gfpgan==1.3.8 \
              realesrgan==0.3.0
          
          # Verify installations
          RUN python -c "import numpy; print(f'NumPy: {numpy.__version__}'); assert numpy.__version__ == '1.24.3'"
          
          CMD ["bash"]
          EOF
          
          # Buat requirements.txt
          cat > requirements.txt << 'EOF'
          numpy==1.24.3
          torch==2.0.1
          torchvision==0.15.2
          opencv-python-headless==4.8.1.78
          Pillow==9.5.0
          basicsr==1.4.2
          facexlib==0.3.0
          gfpgan==1.3.8
          realesrgan==0.3.0
          EOF
          
      - name: Build Docker image
        run: docker build -t realesrgan-upscaler .
        
      - name: Run upscaling in Docker
        run: |
          # Jalankan container dengan bind mount
          docker run --rm \
            -v "$(pwd)/images:/workspace/images" \
            -v "$(pwd)/weights:/workspace/weights" \
            -v "$(pwd)/upscaled:/workspace/upscaled" \
            realesrgan-upscaler \
            bash -c "
            # Download model jika belum ada
            if [ ! -f /workspace/weights/realesr-general-x4v3.pth ]; then
              mkdir -p /workspace/weights
              wget -O /workspace/weights/realesr-general-x4v3.pth \
                https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
            fi
            
            # Buat script Python
            cat > /workspace/upscale.py << 'PYEOF'
          import os
          import sys
          import cv2
          import glob
          import traceback
          
          print('=' * 60)
          print('Real-ESRGAN Upscaler - Docker Version')
          print('=' * 60)
          
          # Debug info
          import numpy as np
          import torch
          print(f'NumPy: {np.__version__}')
          print(f'PyTorch: {torch.__version__}')
          print(f'OpenCV: {cv2.__version__}')
          
          try:
              from basicsr.archs.srvgg_arch import SRVGGNetCompact
              from realesrgan import RealESRGANer
              print('âœ“ Real-ESRGAN imported successfully')
          except ImportError as e:
              print(f'âœ— Import error: {e}')
              sys.exit(1)
          
          # Configuration
          input_dir = 'images'
          output_dir = 'upscaled'
          model_path = 'weights/realesr-general-x4v3.pth'
          
          # Check input
          if not os.path.exists(input_dir):
              print(f'Error: {input_dir} directory not found!')
              sys.exit(1)
          
          # Create output
          os.makedirs(output_dir, exist_ok=True)
          
          # Initialize model
          print('\\nLoading Real-ESRGAN model...')
          try:
              model = SRVGGNetCompact(
                  num_in_ch=3,
                  num_out_ch=3,
                  num_feat=64,
                  num_conv=32,
                  upscale=4,
                  act_type='prelu'
              )
              
              upsampler = RealESRGANer(
                  scale=4,
                  model_path=model_path,
                  model=model,
                  tile=0,
                  tile_pad=10,
                  pre_pad=0,
                  half=False,
                  device='cpu'
              )
              print('âœ“ Model loaded')
          except Exception as e:
              print(f'âœ— Model loading failed: {e}')
              traceback.print_exc()
              sys.exit(1)
          
          # Find images
          images = []
          for ext in ['.jpg', '.jpeg', '.png', '.bmp', '.webp']:
              images.extend(glob.glob(os.path.join(input_dir, '**', f'*{ext}'), recursive=True))
          
          print(f'\\nFound {len(images)} images')
          
          if len(images) == 0:
              print('No images found!')
              sys.exit(1)
          
          # Process images
          success = 0
          for i, img_path in enumerate(images, 1):
              try:
                  filename = os.path.basename(img_path)
                  print(f'[{i}/{len(images)}] Processing: {filename}')
                  
                  # Read image
                  img = cv2.imread(img_path, cv2.IMREAD_UNCHANGED)
                  if img is None:
                      print(f'  âœ— Failed to read image')
                      continue
                  
                  # Upscale
                  output, _ = upsampler.enhance(img, outscale=4)
                  
                  # Save
                  output_path = os.path.join(output_dir, filename)
                  cv2.imwrite(output_path, output)
                  
                  success += 1
                  print(f'  âœ“ Saved as {filename}')
                  
              except Exception as e:
                  print(f'  âœ— Error: {str(e)[:100]}')
          
          print(f'\\nDone! Successfully upscaled: {success}/{len(images)} images')
          
          if success == 0:
              print('No images were processed successfully!')
              sys.exit(1)
          PYEOF
            
            # Jalankan script
            cd /workspace
            python upscale.py
            "
            
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: upscaled-images
          path: upscaled/
          retention-days: 90
          
      - name: Create summary
        run: |
          echo "## ðŸŽ‰ Real-ESRGAN Upscaling Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "upscaled" ]; then
            count=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) 2>/dev/null | wc -l)
            
            echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "- **Images Processed**: $count" >> $GITHUB_STEP_SUMMARY
            echo "- **Environment**: Docker with NumPy 1.24.3" >> $GITHUB_STEP_SUMMARY
            echo "- **Model**: RealESRGAN general-x4v3" >> $GITHUB_STEP_SUMMARY
            echo "- **Scale Factor**: 4x" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“ Processed Files" >> $GITHUB_STEP_SUMMARY
            find upscaled -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) 2>/dev/null | head -10 | while read f; do
              echo "- $(basename "$f")" >> $GITHUB_STEP_SUMMARY
            done
            
            if [ $count -gt 10 ]; then
              echo "- ... and $((count - 10)) more" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Processing Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi