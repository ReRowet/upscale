name: Real-ESRGAN Image Upscaler

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]
  
  workflow_dispatch:  # Bisa trigger manual

jobs:
  upscale:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository (with models)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Download semua file termasuk models
        
    - name: Setup Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install dependencies (minimal)
      run: |
        # Force numpy 1.x
        pip install "numpy<2"
        
        # Install PyTorch CPU
        pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
        
        # Install Real-ESRGAN
        pip install basicsr==1.4.2
        pip install realesrgan==0.3.0
        pip install Pillow>=9.0.0
        pip install opencv-python-headless>=4.8.0
        
    - name: Run upscale script
      run: |
        python scripts/upscale.py \
          --input images \
          --output upscaled \
          --model models/realesr-general-wdn-x4v3.pth \
          --scale 4
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: upscaled-images
        path: upscaled/
        retention-days: 90
        
    - name: Create summary
      run: |
        echo "## ðŸ–¼ï¸ Image Upscaling Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "upscaled" ]; then
          count=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
          echo "### âœ… Success!" >> $GITHUB_STEP_SUMMARY
          echo "- **Processed**: $count images" >> $GITHUB_STEP_SUMMARY
          echo "- **Model**: realesr-general-wdn-x4v3.pth" >> $GITHUB_STEP_SUMMARY
          echo "- **Scale**: 4x" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Files:" >> $GITHUB_STEP_SUMMARY
          find upscaled -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | head -5 | while read f; do
            echo "- $(basename "$f")" >> $GITHUB_STEP_SUMMARY
          done
          
          total=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
          if [ $total -gt 5 ]; then
            echo "- ... and $((total - 5)) more" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "### âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "No output generated. Check logs." >> $GITHUB_STEP_SUMMARY
        fi