name: Real-ESRGAN Upscale (Docker Solution)

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]

jobs:
  upscale:
    runs-on: ubuntu-latest
    container:
      image: pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            wget \
            git \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender-dev \
            libgomp1
          rm -rf /var/lib/apt/lists/*
          
      - name: Install Python dependencies (WITH NUMPY 1.x)
        run: |
          # Uninstall numpy 2.x if exists
          pip uninstall -y numpy || true
          
          # Force install numpy 1.24.3
          pip install "numpy==1.24.3" --force-reinstall
          
          # Install other dependencies
          pip install basicsr==1.4.2
          pip install facexlib==0.3.0
          pip install gfpgan==1.3.8
          pip install opencv-python-headless==4.8.1.78
          pip install Pillow==9.5.0
          pip install realesrgan==0.3.0
          
          # Verify installations
          python -c "
          import numpy; print(f'NumPy: {numpy.__version__}')
          import torch; print(f'PyTorch: {torch.__version__}')
          import cv2; print(f'OpenCV: {cv2.__version__}')
          "
          
      - name: Download model
        run: |
          mkdir -p weights
          wget -q -O weights/realesr-general-x4v3.pth \
            https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
          
      - name: Create simple inference script
        run: |
          cat > upscale.py << 'EOF'
          import os
          import sys
          import cv2
          import glob
          import argparse
          
          sys.path.insert(0, '/workspace')
          
          from basicsr.archs.srvgg_arch import SRVGGNetCompact
          from realesrgan import RealESRGANer
          
          def main():
              parser = argparse.ArgumentParser()
              parser.add_argument('--input', type=str, default='images', help='Input folder')
              parser.add_argument('--output', type=str, default='upscaled', help='Output folder')
              parser.add_argument('--model', type=str, default='weights/realesr-general-x4v3.pth', help='Model path')
              args = parser.parse_args()
              
              print("=" * 60)
              print("Real-ESRGAN Upscaler")
              print("=" * 60)
              
              # Debug info
              import numpy as np
              import torch
              print(f"NumPy version: {np.__version__}")
              print(f"PyTorch version: {torch.__version__}")
              
              # Check input
              if not os.path.exists(args.input):
                  print(f"Error: Input directory '{args.input}' does not exist!")
                  return
              
              # Create output
              os.makedirs(args.output, exist_ok=True)
              
              # Initialize model
              print("\nLoading model...")
              model = SRVGGNetCompact(
                  num_in_ch=3,
                  num_out_ch=3,
                  num_feat=64,
                  num_conv=32,
                  upscale=4,
                  act_type='prelu'
              )
              
              upsampler = RealESRGANer(
                  scale=4,
                  model_path=args.model,
                  model=model,
                  tile=0,
                  tile_pad=10,
                  pre_pad=0,
                  half=False,
                  device='cpu'
              )
              
              print("Model loaded!")
              
              # Find images
              images = []
              for ext in ['.jpg', '.jpeg', '.png', '.bmp', '.webp']:
                  images.extend(glob.glob(os.path.join(args.input, '**', f'*{ext}'), recursive=True))
                  images.extend(glob.glob(os.path.join(args.input, '**', f'*{ext.upper()}'), recursive=True))
              
              print(f"\nFound {len(images)} images")
              
              # Process
              success = 0
              for i, img_path in enumerate(images):
                  try:
                      rel_path = os.path.relpath(img_path, args.input)
                      output_path = os.path.join(args.output, rel_path)
                      os.makedirs(os.path.dirname(output_path), exist_ok=True)
                      
                      print(f"[{i+1}/{len(images)}] {rel_path}")
                      
                      img = cv2.imread(img_path, cv2.IMREAD_UNCHANGED)
                      if img is None:
                          print(f"  Failed to read")
                          continue
                      
                      output, _ = upsampler.enhance(img, outscale=4)
                      cv2.imwrite(output_path, output)
                      
                      success += 1
                      print(f"  âœ“ Saved")
                      
                  except Exception as e:
                      print(f"  âœ— Error: {e}")
              
              print(f"\nDone! Success: {success}/{len(images)}")
              
              if success == 0:
                  sys.exit(1)
          
          if __name__ == "__main__":
              main()
          EOF
          
      - name: Run upscaling
        run: python upscale.py --input images --output upscaled
        
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: upscaled-images
          path: upscaled/
          retention-days: 90
          
      - name: Create summary
        run: |
          echo "## âœ… Real-ESRGAN Upscaling Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "upscaled" ]; then
            count=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
            echo "### ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Success âœ…" >> $GITHUB_STEP_SUMMARY
            echo "- **Images Processed**: $count" >> $GITHUB_STEP_SUMMARY
            echo "- **Model**: RealESRGAN general-x4v3" >> $GITHUB_STEP_SUMMARY
            echo "- **Scale**: 4x" >> $GITHUB_STEP_SUMMARY
            echo "- **Environment**: Docker (PyTorch 2.0.1 + NumPy 1.24.3)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### ðŸ“ Files" >> $GITHUB_STEP_SUMMARY
            find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | head -10 | while read f; do
              echo "- $(basename "$f")" >> $GITHUB_STEP_SUMMARY
            done
            total=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
            if [ $total -gt 10 ]; then
              echo "- ... and $((total - 10)) more" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Processing Failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi