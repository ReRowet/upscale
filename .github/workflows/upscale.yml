name: Real-ESRGAN From Source

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]

jobs:
  upscale:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Python 3.9 with fresh environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          git \
          build-essential \
          cmake \
          libopenblas-dev \
          liblapack-dev \
          libx11-dev \
          libgl1-mesa-glx
        
    - name: Create completely fresh environment
      run: |
        # Hapus semua package system
        pip freeze | xargs pip uninstall -y 2>/dev/null || true
        
        # Build dan install NumPy dari source dengan versi 1.24.3
        echo "Building NumPy 1.24.3 from source..."
        wget https://github.com/numpy/numpy/archive/refs/tags/v1.24.3.tar.gz
        tar -xzf v1.24.3.tar.gz
        cd numpy-1.24.3
        pip install . --no-binary numpy
        cd ..
        
        # Verifikasi
        python -c "import numpy; print(f'NumPy version: {numpy.__version__}'); assert numpy.__version__ == '1.24.3'"
        
    - name: Build PyTorch from source (CPU only)
      run: |
        echo "Installing PyTorch from wheel..."
        # Install PyTorch CPU dari wheel yang sudah ada
        pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
        
        # Verifikasi
        python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print('CUDA available:', torch.cuda.is_available())"
        
    - name: Build OpenCV from source
      run: |
        echo "Installing OpenCV..."
        pip install opencv-python-headless==4.8.1.78
        
    - name: Build BasicSR from source
      run: |
        echo "Building BasicSR from source..."
        git clone https://github.com/xinntao/BasicSR.git
        cd BasicSR
        
        # Install requirements
        pip install -r requirements.txt
        
        # Install in development mode
        pip install -e .
        
        cd ..
        
    - name: Install Real-ESRGAN
      run: |
        echo "Installing Real-ESRGAN..."
        pip install realesrgan==0.3.0
        pip install Pillow==9.5.0
        
    - name: Create ultra-simple upscale script
      run: |
        cat > upscale_ultra.py << 'EOF'
        """
        Ultra Simple Real-ESRGAN Upscaler
        Direct implementation with minimal imports
        """
        import os
        import sys
        import glob
        import traceback
        
        print("=" * 70)
        print("ULTRA SIMPLE Real-ESRGAN Upscaler")
        print("=" * 70)
        
        # Debug: Check what's available
        import subprocess
        result = subprocess.run([sys.executable, "-m", "pip", "list"], capture_output=True, text=True)
        print("Installed packages:")
        print(result.stdout[:500])
        
        # Try to import
        try:
            import numpy as np
            print(f"âœ“ NumPy: {np.__version__}")
            
            import torch
            print(f"âœ“ PyTorch: {torch.__version__}")
            
            # Try to import Real-ESRGAN directly
            import importlib.util
            
            # Method 1: Try direct import
            try:
                from realesrgan import RealESRGAN
                print("âœ“ Imported RealESRGAN class")
                METHOD = "class"
            except:
                # Method 2: Try basic imports
                from basicsr.archs.srvgg_arch import SRVGGNetCompact
                from realesrgan import RealESRGANer
                print("âœ“ Imported SRVGGNetCompact and RealESRGANer")
                METHOD = "upsampler"
                
        except Exception as e:
            print(f"âœ— Import failed: {e}")
            traceback.print_exc()
            sys.exit(1)
        
        def upscale_images():
            """Main upscaling function"""
            input_dir = "images"
            output_dir = "upscaled"
            model_path = "models/realesr-general-wdn-x4v3.pth"
            
            # Check directories
            if not os.path.exists(input_dir):
                print(f"âœ— Input directory '{input_dir}' not found!")
                return False
                
            if not os.path.exists(model_path):
                print(f"âœ— Model '{model_path}' not found!")
                print("Please download the model and place it in models/ folder")
                return False
            
            os.makedirs(output_dir, exist_ok=True)
            
            print(f"\nInput: {input_dir}")
            print(f"Output: {output_dir}")
            print(f"Model: {model_path}")
            
            # Find images
            images = []
            for ext in ['.jpg', '.jpeg', '.png', '.bmp', '.webp']:
                pattern = os.path.join(input_dir, '**', f'*{ext}')
                images.extend(glob.glob(pattern, recursive=True))
                pattern = os.path.join(input_dir, '**', f'*{ext.upper()}')
                images.extend(glob.glob(pattern, recursive=True))
            
            images = list(set(images))
            
            print(f"\nFound {len(images)} images")
            
            if not images:
                print("âœ— No images found!")
                return False
            
            # Initialize model based on method
            if METHOD == "class":
                print("\nInitializing RealESRGAN class...")
                try:
                    device = torch.device('cpu')
                    model = RealESRGAN(device, scale=4)
                    model.load_weights(model_path)
                    print("âœ“ Model loaded (class method)")
                    
                    # Process images
                    import cv2
                    from PIL import Image
                    
                    success = 0
                    for i, img_path in enumerate(images, 1):
                        try:
                            filename = os.path.basename(img_path)
                            output_path = os.path.join(output_dir, filename)
                            
                            print(f"[{i}/{len(images)}] {filename}")
                            
                            img = Image.open(img_path).convert('RGB')
                            sr_img = model.predict(img)
                            sr_img.save(output_path)
                            
                            success += 1
                            print(f"  âœ“ Saved")
                            
                        except Exception as e:
                            print(f"  âœ— Error: {str(e)[:100]}")
                    
                    print(f"\nâœ… Successfully upscaled {success}/{len(images)} images")
                    return success > 0
                    
                except Exception as e:
                    print(f"âœ— Class method failed: {e}")
                    return False
                    
            elif METHOD == "upsampler":
                print("\nInitializing RealESRGANer...")
                try:
                    import cv2
                    
                    model = SRVGGNetCompact(
                        num_in_ch=3, num_out_ch=3, num_feat=64,
                        num_conv=32, upscale=4, act_type='prelu'
                    )
                    
                    upsampler = RealESRGANer(
                        scale=4,
                        model_path=model_path,
                        model=model,
                        tile=0,
                        tile_pad=10,
                        pre_pad=0,
                        half=False,
                        device='cpu'
                    )
                    
                    print("âœ“ Model loaded (upsampler method)")
                    
                    # Process images
                    success = 0
                    for i, img_path in enumerate(images, 1):
                        try:
                            filename = os.path.basename(img_path)
                            output_path = os.path.join(output_dir, filename)
                            
                            print(f"[{i}/{len(images)}] {filename}")
                            
                            img = cv2.imread(img_path, cv2.IMREAD_UNCHANGED)
                            if img is None:
                                print(f"  âœ— Failed to read")
                                continue
                            
                            output, _ = upsampler.enhance(img, outscale=4)
                            cv2.imwrite(output_path, output)
                            
                            success += 1
                            print(f"  âœ“ Saved")
                            
                        except Exception as e:
                            print(f"  âœ— Error: {str(e)[:100]}")
                    
                    print(f"\nâœ… Successfully upscaled {success}/{len(images)} images")
                    return success > 0
                    
                except Exception as e:
                    print(f"âœ— Upsampler method failed: {e}")
                    traceback.print_exc()
                    return False
        
        if __name__ == "__main__":
            success = upscale_images()
            if not success:
                sys.exit(1)
        EOF
        
    - name: Run upscaling
      run: |
        echo "Starting upscaling..."
        python upscale_ultra.py
        
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: upscaled-images
        path: upscaled/
        
    - name: Create summary
      run: |
        echo "## ðŸŽ‰ Upscaling Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "upscaled" ] && [ "$(ls -A upscaled 2>/dev/null)" ]; then
          count=$(ls -1 upscaled/*.{jpg,jpeg,png} 2>/dev/null | wc -l)
          echo "### âœ… Success!" >> $GITHUB_STEP_SUMMARY
          echo "- **Images processed**: $count" >> $GITHUB_STEP_SUMMARY
          echo "- **Method**: Built from source" >> $GITHUB_STEP_SUMMARY
          echo "- **NumPy version**: 1.24.3 (built from source)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“ Output files:" >> $GITHUB_STEP_SUMMARY
          ls -1 upscaled/*.{jpg,jpeg,png} 2>/dev/null | head -5 | xargs -I {} basename {} | while read file; do
            echo "- $file" >> $GITHUB_STEP_SUMMARY
          done
        else
          echo "### âŒ Failed" >> $GITHUB_STEP_SUMMARY
          echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
        fi