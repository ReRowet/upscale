name: Real-ESRGAN Upscale (Fixed)

on:
  push:
    paths:
      - 'images/**'
    branches: [ main ]

jobs:
  upscale:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with: 
          python-version: "3.10"
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # FIX: Install numpy versi 1.x sebelum package lain
          pip install "numpy==1.24.3"
          
          # Install PyTorch CPU
          pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
          
          # Install Real-ESRGAN dependencies
          pip install basicsr==1.4.2
          pip install facexlib==0.3.0
          pip install gfpgan==1.3.8
          pip install Pillow==9.5.0
          pip install opencv-python-headless==4.8.1.78
          
          # Install realesrgan
          pip install realesrgan==0.3.0
          
      - name: Download model
        run: |
          mkdir -p weights
          wget -q -O weights/realesr-general-x4v3.pth \
            https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
          
      - name: Create upscale script
        run: |
          cat > upscale_images.py << 'EOF'
          import os
          import cv2
          import glob
          
          # Try to import Real-ESRGAN
          try:
              from basicsr.archs.rrdbnet_arch import RRDBNet
              from realesrgan import RealESRGANer
          except:
              print("Error importing Real-ESRGAN")
              exit(1)
          
          # Setup
          input_dir = "images"
          output_dir = "upscaled"
          model_path = "weights/realesr-general-x4v3.pth"
          
          # Create output directory
          os.makedirs(output_dir, exist_ok=True)
          
          # Initialize upsampler
          model = RRDBNet(num_in_ch=3, num_out_ch=3, num_feat=64, num_block=23, num_grow_ch=32, scale=4)
          upsampler = RealESRGANer(
              scale=4,
              model_path=model_path,
              model=model,
              tile=0,
              tile_pad=10,
              pre_pad=0,
              half=False,
              device='cpu'
          )
          
          # Get all images
          images = []
          for ext in ['*.jpg', '*.jpeg', '*.png', '*.bmp', '*.webp']:
              images.extend(glob.glob(os.path.join(input_dir, '**', ext), recursive=True))
          
          print(f"Found {len(images)} images")
          
          # Process images
          for i, img_path in enumerate(images):
              print(f"[{i+1}/{len(images)}] Processing {os.path.basename(img_path)}")
              
              # Read image
              img = cv2.imread(img_path, cv2.IMREAD_UNCHANGED)
              if img is None:
                  print(f"  Failed to read image")
                  continue
              
              # Upscale
              try:
                  output, _ = upsampler.enhance(img, outscale=4)
                  
                  # Save with same name
                  filename = os.path.basename(img_path)
                  name, ext = os.path.splitext(filename)
                  output_path = os.path.join(output_dir, f"{name}_x4{ext}")
                  
                  cv2.imwrite(output_path, output)
                  print(f"  Saved to {output_path}")
              except Exception as e:
                  print(f"  Error: {e}")
          
          print("Done!")
          EOF
          
      - name: Run upscaling
        run: python upscale_images.py
        
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: upscaled-images
          path: upscaled/