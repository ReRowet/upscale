name: Real-ESRGAN Batch Upscale

on:
  push:
    paths:
      - 'images/**'
    branches: [ main, master ]
  
  workflow_dispatch:
    inputs:
      batch_name:
        description: 'Process specific batch folder'
        required: false
        default: ''
      scale:
        description: 'Upscale factor'
        required: false
        default: '4'
        type: choice
        options: ['2', '4']

jobs:
  upscale-batch:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with: 
          python-version: "3.10"  # Gunakan 3.10 untuk kompatibilitas lebih baik
          
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
            
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          # Install PyTorch untuk CPU
          pip install torch==2.0.1 torchvision==0.15.2 --index-url https://download.pytorch.org/whl/cpu
          # Install Real-ESRGAN dan dependencies
          pip install realesrgan==0.3.0
          pip install basicsr==1.4.2
          pip install pillow>=9.0.0
          pip install numpy==1.24.3  # Versi spesifik untuk kompatibilitas
          
      - name: Download Real-ESRGAN model
        run: |
          mkdir -p weights
          if [ ! -f "weights/realesr-general-x4v3.pth" ]; then
            echo "Downloading Real-ESRGAN model..."
            wget -q --show-progress -O weights/realesr-general-x4v3.pth \
              https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
          else
            echo "Model already exists, skipping download."
          fi
          
      - name: Create upscale script
        run: |
          cat > upscale_simple.py << 'EOF'
          import os
          import sys
          from pathlib import Path
          
          import torch
          from PIL import Image
          from realesrgan import RealESRGAN
          
          def main():
              # Setup
              input_dir = Path("images")
              output_dir = Path("upscaled")
              output_dir.mkdir(exist_ok=True)
              
              # Load model
              device = torch.device("cpu")
              print("Loading Real-ESRGAN model...")
              model = RealESRGAN(device, scale=4)
              model.load_weights("weights/realesr-general-x4v3.pth")
              print("Model loaded successfully!")
              
              # Process images
              processed = 0
              failed = 0
              
              # Recursive search for images
              image_extensions = {'.jpg', '.jpeg', '.png', '.bmp', '.tiff', '.webp'}
              
              for ext in image_extensions:
                  for image_path in input_dir.rglob(f"*{ext}"):
                      try:
                          # Calculate output path preserving structure
                          rel_path = image_path.relative_to(input_dir)
                          output_path = output_dir / rel_path
                          output_path.parent.mkdir(parents=True, exist_ok=True)
                          
                          print(f"Processing: {rel_path}")
                          
                          # Load and upscale image
                          img = Image.open(image_path).convert("RGB")
                          sr = model.predict(img)
                          
                          # Save with same format
                          sr.save(output_path)
                          processed += 1
                          
                      except Exception as e:
                          print(f"Error processing {image_path}: {e}")
                          failed += 1
              
              print(f"\nProcessing complete!")
              print(f"Successfully upscaled: {processed} images")
              print(f"Failed: {failed} images")
              
              if processed == 0 and failed == 0:
                  print("No images found in 'images' directory!")
                  sys.exit(1)
          
          if __name__ == "__main__":
              main()
          EOF
          
      - name: Run upscaling
        run: |
          echo "Starting upscaling process..."
          python upscale_simple.py
          
      - name: Upload upscaled images
        uses: actions/upload-artifact@v4
        with:
          name: upscaled-images
          path: upscaled/
          
      - name: Create summary
        run: |
          echo "## ðŸ–¼ï¸ Image Upscaling Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Statistics" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files
          if [ -d "upscaled" ]; then
            file_count=$(find upscaled -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
            echo "- **Upscaled Images**: $file_count" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # List directories
            echo "### ðŸ“ Output Structure" >> $GITHUB_STEP_SUMMARY
            find upscaled -type d | sort | while read dir; do
              count=$(find "$dir" -maxdepth 1 -type f \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \) | wc -l)
              if [ $count -gt 0 ]; then
                rel_dir=${dir#upscaled/}
                echo "- **$rel_dir**: $count images" >> $GITHUB_STEP_SUMMARY
              fi
            done
          else
            echo "- **Upscaled Images**: 0 (No images processed)" >> $GITHUB_STEP_SUMMARY
          fi