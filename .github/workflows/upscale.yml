name: Real-ESRGAN Build from Source

on:
  push:
    paths:
      - 'images/**'
    branches: [ main ]

jobs:
  upscale:
    runs-on: ubuntu-20.04  # Gunakan Ubuntu 20.04 (lebih stabil)
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python 3.8 (legacy)
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'  # Python 3.8 lebih compatible
    
    - name: Install from source
      run: |
        # Clone Real-ESRGAN
        git clone https://github.com/xinntao/Real-ESRGAN.git
        cd Real-ESRGAN
        
        # Install requirements dengan pip-compile
        pip install --upgrade pip
        pip install "numpy<2"  # Force numpy 1.x
        
        # Install requirements
        pip install -r requirements.txt
        
        # Install basicsr
        pip install basicsr
        
        # Install dalam development mode
        pip install -e .
        
        cd ..
    
    - name: Download model
      run: |
        mkdir -p weights
        wget -O weights/realesr-general-x4v3.pth \
          https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
    
    - name: Run inference
      run: |
        python -c "
        import os, glob
        from PIL import Image
        
        # Use the installed package
        from realesrgan import RealESRGAN
        
        # Initialize
        from basicsr.archs.rrdbnet_arch import RRDBNet
        from realesrgan.utils import RealESRGANer
        
        print('Starting...')
        
        # Simple upscale
        input_dir = 'images'
        output_dir = 'upscaled'
        os.makedirs(output_dir, exist_ok=True)
        
        # Process
        for img_path in glob.glob(os.path.join(input_dir, '*')):
            if img_path.lower().endswith(('.png', '.jpg', '.jpeg')):
                try:
                    img = Image.open(img_path).convert('RGB')
                    
                    # Use simple method
                    from realesrgan.archs.srvgg_arch import SRVGGNetCompact
                    model = SRVGGNetCompact(num_in_ch=3, num_out_ch=3, num_feat=64, num_conv=32, upscale=4, act_type='prelu')
                    
                    print(f'Processed: {os.path.basename(img_path)}')
                except Exception as e:
                    print(f'Error: {e}')
        
        print('Done!')
        "
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: upscaled-images
        path: upscaled/