name: Real-ESRGAN Simple Upscale

on:
  push:
    paths:
      - 'images/**'
    branches: [ main ]

jobs:
  upscale:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install with pip from requirements.txt
      run: |
        # Buat requirements.txt yang aman
        cat > requirements.txt << 'EOF'
        numpy==1.24.3
        torch==2.0.1
        torchvision==0.15.2
        Pillow==9.5.0
        basicsr==1.4.2
        facexlib==0.3.0
        gfpgan==1.3.8
        realesrgan==0.3.0
        EOF
        
        # Install dengan --no-deps untuk menghindari konflik
        pip install --upgrade pip
        pip install numpy==1.24.3
        pip install -r requirements.txt --no-deps
        pip install -r requirements.txt
        
    - name: Download model
      run: |
        mkdir -p weights
        wget -O weights/realesr-general-x4v3.pth \
          https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesr-general-x4v3.pth
        
    - name: Create simple script (PIL only)
      run: |
        cat > simple_upscale.py << 'EOF'
        import os
        import sys
        import glob
        from PIL import Image
        import torch
        
        # Import Real-ESRGAN dengan cara yang berbeda
        try:
            # Coba import dengan cara langsung
            sys.path.insert(0, '/opt/hostedtoolcache/Python/3.10.19/x64/lib/python3.10/site-packages')
            from realesrgan.archs.srvgg_arch import SRVGGNetCompact
            from basicsr.archs.rrdbnet_arch import RRDBNet
            from realesrgan.utils import RealESRGANer
        except:
            # Fallback ke cara lama
            from basicsr.archs.rrdbnet_arch import RRDBNet
            from realesrgan import RealESRGANer
        
        def upscale_image(image_path, output_path, upsampler):
            """Upscale single image"""
            try:
                # Buka gambar dengan PIL
                img = Image.open(image_path).convert('RGB')
                
                # Convert PIL ke numpy array (BGR format untuk Real-ESRGAN)
                import numpy as np
                img_np = np.array(img)[:, :, ::-1]  # RGB to BGR
                
                # Upscale
                output, _ = upsampler.enhance(img_np, outscale=4)
                
                # Convert kembali ke PIL dan simpan
                output_rgb = output[:, :, ::-1]  # BGR to RGB
                Image.fromarray(output_rgb).save(output_path)
                return True
            except Exception as e:
                print(f"Error: {e}")
                return False
        
        def main():
            # Setup
            input_dir = "images"
            output_dir = "upscaled"
            os.makedirs(output_dir, exist_ok=True)
            
            # Inisialisasi model
            print("Initializing Real-ESRGAN...")
            model = RRDBNet(num_in_ch=3, num_out_ch=3, num_feat=64, 
                           num_block=23, num_grow_ch=32, scale=4)
            
            upsampler = RealESRGANer(
                scale=4,
                model_path='weights/realesr-general-x4v3.pth',
                model=model,
                tile=0,
                tile_pad=10,
                pre_pad=0,
                half=False,
                device=torch.device('cpu')
            )
            
            # Cari semua gambar
            images = []
            for ext in ['.jpg', '.jpeg', '.png', '.bmp', '.webp']:
                images.extend(glob.glob(os.path.join(input_dir, '**', f'*{ext}'), recursive=True))
                images.extend(glob.glob(os.path.join(input_dir, '**', f'*{ext.upper()}'), recursive=True))
            
            print(f"Found {len(images)} images")
            
            # Process images
            success = 0
            for i, img_path in enumerate(images):
                filename = os.path.basename(img_path)
                name, ext = os.path.splitext(filename)
                output_path = os.path.join(output_dir, f"{name}_x4{ext}")
                
                print(f"[{i+1}/{len(images)}] Processing {filename}")
                
                if upscale_image(img_path, output_path, upsampler):
                    success += 1
                    print(f"  -> Saved as {filename}_x4{ext}")
                else:
                    print(f"  -> Failed")
            
            print(f"\nDone! Successfully upscaled {success}/{len(images)} images")
            
            if success == 0:
                sys.exit(1)
        
        if __name__ == "__main__":
            main()
        EOF
        
    - name: Run upscaling
      run: python simple_upscale.py
      
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: upscaled-images
        path: upscaled/